<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nockchain State Jams</title>
  <meta name="description" content="Download Nockchain state jam binaries and verify SHA-256 checksums.">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <a class="back-link" href="/">&larr; nockchain.net</a>
    <h1><img src="jam-icon.png" alt="jam-icon" class="jam-icon">State Jams</h1>
    <p class="meta">Download state jam binaries and verify each file with SHA-256.</p>
    <p>
      <a class="button" id="latest-link" href="#" target="_blank" rel="noopener" hidden>Download latest .jam</a>
    </p>
    <p class="meta">
      Checksum source:
      <a href="/jams/SHA256SUMS">/jams/SHA256SUMS</a>
    </p>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th class="file-col">File</th>
            <th class="hash-col">SHA-256</th>
          </tr>
        </thead>
        <tbody id="hash-table-body">
          <tr>
            <td colspan="2">Loading checksums...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <p id="status" class="status"></p>

    <script>
      const DRIVE_ICON_URL = "https://ssl.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png";

      async function loadHashes() {
        const tableBody = document.getElementById("hash-table-body");
        const status = document.getElementById("status");
        const latestLink = document.getElementById("latest-link");

        try {
          const response = await fetch("/jams/SHA256SUMS", { cache: "no-store" });
          if (!response.ok) {
            throw new Error("HTTP " + response.status);
          }

          const text = await response.text();
          const rows = [];

          for (const rawLine of text.split("\n")) {
            const line = rawLine.trim();
            if (!line) continue;

            const match = line.match(/^([a-fA-F0-9]{64})\s+(.+)$/);
            if (!match) continue;

            const hash = match[1].toLowerCase();
            const path = match[2].trim();
            if (!path.endsWith(".jam")) continue;

            const cleanPath = path.replace(/^\.?\//, "");
            rows.push({ hash, path: cleanPath });
          }

          function blockNum(p) {
            var m = p.match(/(\d+)\.jam$/);
            return m ? parseInt(m[1], 10) : 0;
          }
          rows.sort((a, b) => blockNum(b.path) - blockNum(a.path));

          if (!rows.length) {
            tableBody.innerHTML = "<tr><td colspan='2'>No .jam entries found in /jams/SHA256SUMS.</td></tr>";
            status.textContent = "No jam binaries are currently listed.";
            return;
          }

          let driveFileIds = {};
          try {
            const driveRes = await fetch("/jams/drive_files.json", { cache: "no-store" });
            if (driveRes.ok) {
              const data = await driveRes.json();
              if (Array.isArray(data)) {
                data.forEach(item => {
                  if (!item.IsDir && item.Path && item.ID) {
                    driveFileIds[item.Path] = item.ID;
                  }
                });
              }
            }
          } catch (_) { }

          function driveViewUrl(id) {
            return "https://drive.google.com/file/d/" + id + "/view?usp=drive_link";
          }

          tableBody.innerHTML = rows.map(({ hash, path }, i) => {
            const fileName = path.split("/").pop();
            const localHref = path.startsWith("jams/") ? "/" + path : "./" + fileName;
            const tag = i === 0 ? " <span class='tag-newest'>latest</span>" : "";
            const driveId = driveFileIds[fileName];
            const cellContent = driveId
              ? "<a href='" + driveViewUrl(driveId) + "'><img src='" + DRIVE_ICON_URL + "' alt='Drive' class='drive-icon'>" + fileName + "</a>"
              : "<a href='" + localHref + "' download>" + fileName + "</a>";
            return (
              "<tr>" +
              "<td>" + tag + cellContent + "</td>" +
              "<td><code>" + hash + "</code></td>" +
              "</tr>"
            );
          }).join("");

          const latestPath = rows[0].path;
          const latestName = latestPath.split("/").pop();
          const latestDriveId = driveFileIds[latestName];
          if (latestDriveId) {
            latestLink.href = driveViewUrl(latestDriveId);
            latestLink.innerHTML = "<img src='" + DRIVE_ICON_URL + "' alt='Drive' class='drive-icon'>Download Latest " + latestName;
            latestLink.removeAttribute("download");
          } else {
            const latestHref = latestPath.startsWith("jams/") ? "/" + latestPath : "./" + latestName;
            latestLink.href = latestHref;
            latestLink.textContent = "Download Latest " + latestName;
            latestLink.download = latestName;
            latestLink.removeAttribute("target");
            latestLink.removeAttribute("rel");
          }
          latestLink.hidden = false;

          status.textContent = "Loaded " + rows.length + " jam file checksum(s).";
        } catch (error) {
          tableBody.innerHTML = "<tr><td colspan='2'>Unable to load checksum manifest.</td></tr>";
          status.textContent = "Error loading /jams/SHA256SUMS: " + error.message;
          status.classList.add("error");
        }
      }

      loadHashes();
    </script>

    <div class="admin-section">
      <h2>Admin</h2>
      <p class="meta">Export a new state jam from the current chain tip and update checksums.</p>
      <div class="admin-row">
        <input type="password" id="api-key-input" placeholder="API key" autocomplete="off">
        <button class="button" id="run-btn"><img src="jam-icon.png" alt=""
            style="height:1.2em;vertical-align:middle;margin-right:0.4em;">Make Jam</button>
      </div>
      <p class="job-indicator">
        <span class="icon" id="job-icon">â—‹</span>
        <span id="job-label">Idle</span>
        <span id="job-detail" class="meta" style="margin-left:0.6em;"></span>
      </p>
      <div class="output-box" id="job-output"></div>
    </div>
    <p class="footer">
      Questions? Contact <a target="_blank" href="https://t.me/nocktoshi">@nocktoshi</a> on telegram. <br /><br />
      <a target="_blank" href="https://www.vecteezy.com/vector-art/49568465-strawberry-jam-illustration">Strawberry Jam
        Vector by
        Giuseppe Ramos</a>
    </p>
    <script>
      (function () {
        const KEY_STORAGE = "nj_api_key";
        const keyInput = document.getElementById("api-key-input");
        const runBtn = document.getElementById("run-btn");
        const icon = document.getElementById("job-icon");
        const label = document.getElementById("job-label");
        const output = document.getElementById("job-output");
        let polling = null;

        const saved = localStorage.getItem(KEY_STORAGE);
        if (saved) keyInput.value = saved;

        const detail = document.getElementById("job-detail");
        const ICONS = { idle: "\u25CB", running: "\uD83D\uDFE2", done: "\u2705", fail: "\u274C" };

        function setIndicator(state, text, extra) {
          icon.textContent = ICONS[state] || ICONS.idle;
          label.textContent = text;
          detail.textContent = extra || "";
        }

        function fmtDuration(secs) {
          if (secs < 60) return secs + "s";
          var m = Math.floor(secs / 60), s = secs % 60;
          return m + "m " + s + "s";
        }

        function fmtAgo(iso) {
          var diff = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
          if (diff < 60) return "just now";
          if (diff < 3600) return Math.floor(diff / 60) + "m ago";
          if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
          return Math.floor(diff / 86400) + "d ago";
        }

        async function pollStatus() {
          try {
            const res = await fetch("/api/status");
            if (!res.ok) return;
            const data = await res.json();

            if (data.last_output) {
              output.style.display = "block";
              output.textContent = data.last_output;
              output.scrollTop = output.scrollHeight;
            }

            if (data.running) {
              var extra = data.running_for_secs != null ? "(" + fmtDuration(data.running_for_secs) + ")" : "";
              setIndicator("running", "Job running\u2026", extra);
              runBtn.disabled = true;
            } else if (runBtn.disabled && icon.textContent === ICONS.running) {
              setIndicator(data.last_success ? "done" : "fail",
                data.last_success ? "Completed successfully" : "Failed");
              runBtn.disabled = false;
              loadHashes();
            } else if (!runBtn.disabled) {
              var parts = [];
              if (data.jam_count != null) parts.push(data.jam_count + " jam" + (data.jam_count !== 1 ? "s" : ""));
              if (data.last_completed) {
                var ago = fmtAgo(data.last_completed);
                var status = data.last_success === true ? "\u2705" : data.last_success === false ? "\u274C" : "";
                parts.push("last run " + ago + (status ? " " + status : ""));
              }
              detail.textContent = parts.length ? parts.join(" \u00b7 ") : "";
            }
          } catch (_) { }
        }

        polling = setInterval(pollStatus, 3000);
        pollStatus();

        runBtn.addEventListener("click", async function () {
          const key = keyInput.value.trim();
          if (!key) {
            keyInput.focus();
            return;
          }
          localStorage.setItem(KEY_STORAGE, key);

          runBtn.disabled = true;
          output.style.display = "block";
          output.textContent = "Starting job...";
          setIndicator("running", "Job running\u2026");

          try {
            const res = await fetch("/api/make-jam", {
              method: "POST",
              headers: { "X-API-Key": key },
            });
            const data = await res.json();

            if (!data.success) {
              output.textContent = data.output || "Failed";
              setIndicator("fail", "Failed (HTTP " + res.status + ")");
              runBtn.disabled = false;
            }
          } catch (err) {
            output.textContent = err.message;
            setIndicator("fail", "Request error");
            runBtn.disabled = false;
          }
        });
      })();
    </script>
  </div>
</body>

</html>